<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Immunisation Coworker</title>
  <style>
:root {
  --bg: #eef3f8;
  --card: #ffffff;
  --ink: #11253e;
  --ink-soft: #213b57;
  --muted: #5c7089;
  --line: #d7e1ec;
  --accent: #0a8f79;
  --accent-deep: #076c62;
  --accent-faint: #e5f7f3;
  --warn: #9a6300;
  --danger: #b12b2b;
  --glow: rgba(7, 92, 129, 0.08);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  color: var(--ink);
  font-family: "Avenir Next", "Nunito Sans", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
  background:
    radial-gradient(1200px 450px at -20% -30%, #d9f4ef 0%, transparent 56%),
    radial-gradient(900px 420px at 120% -10%, #deecff 0%, transparent 58%),
    linear-gradient(180deg, #f8fbff 0%, var(--bg) 100%);
}

.app {
  max-width: 1180px;
  margin: 22px auto 56px;
  padding: 0 14px;
}

.top {
  margin-bottom: 14px;
}

.top h1 {
  margin: 0;
  font-size: clamp(1.7rem, 2.5vw, 2.25rem);
  letter-spacing: 0.2px;
  color: #0f2945;
}

.top p {
  margin: 8px 0 0;
  color: var(--muted);
  font-size: 0.98rem;
}

.card {
  position: relative;
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 16px;
  margin: 14px 0;
  box-shadow: 0 16px 30px -24px var(--glow);
}

h2, h3 {
  margin: 14px 0 10px;
  color: var(--ink-soft);
  letter-spacing: 0.1px;
}

label {
  display: block;
  font-size: 14px;
  color: #304860;
  font-weight: 600;
}

input, select, button, textarea {
  width: 100%;
  margin-top: 7px;
  border: 1px solid var(--line);
  border-radius: 11px;
  padding: 11px 12px;
  font: inherit;
  transition: border-color 120ms ease, box-shadow 120ms ease, transform 120ms ease;
}

input, select, textarea {
  background: #fbfdff;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #7db9df;
  box-shadow: 0 0 0 3px rgba(40, 127, 188, 0.12);
}

button {
  cursor: pointer;
  color: #fff;
  font-weight: 700;
  border-color: transparent;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-deep) 100%);
  box-shadow: 0 10px 20px -14px rgba(5, 102, 90, 0.85);
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 22px -16px rgba(5, 102, 90, 0.95);
}

button:active {
  transform: translateY(0);
}

.grid { display: grid; gap: 12px; }
.grid.two { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid.three { grid-template-columns: repeat(3, minmax(0, 1fr)); }

.tabs {
  display: flex;
  gap: 8px;
  margin: 14px 0;
  padding: 4px;
  border: 1px solid var(--line);
  border-radius: 14px;
  background: #f5f9fe;
}

.tab {
  flex: 1;
  margin-top: 0;
  color: #2a4a67;
  background: transparent;
  border: 1px solid transparent;
  box-shadow: none;
}

.tab.active {
  color: #083f39;
  border-color: #b8dfd5;
  background: linear-gradient(135deg, #e6fbf5 0%, #ecf7ff 100%);
  box-shadow: inset 0 0 0 1px rgba(15, 133, 111, 0.09);
}

.tab-pane { display: none; }
.tab-pane.active { display: block; }

.actions {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.actions button {
  width: auto;
  min-width: 160px;
}

.row.between {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  flex-wrap: wrap;
}

.error { color: var(--danger); min-height: 18px; }
.hidden { display: none; }

.meta {
  color: var(--muted);
  margin-bottom: 12px;
  padding: 10px 12px;
  border: 1px dashed #c9d7e7;
  border-radius: 10px;
  background: #f8fbff;
  font-size: 0.94rem;
}

.list {
  margin: 8px 0 10px;
  padding-left: 22px;
}

li.warn { color: var(--warn); }
li.danger { color: var(--danger); }

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 14px;
}

.table-wrap {
  width: 100%;
  overflow-x: auto;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: #fff;
}

th, td {
  border-right: 1px solid var(--line);
  border-bottom: 1px solid var(--line);
  padding: 10px;
  vertical-align: top;
}

th:last-child, td:last-child { border-right: none; }
tr:last-child td { border-bottom: none; }

th {
  position: sticky;
  top: 0;
  z-index: 1;
  text-align: left;
  color: #1c3d5a;
  background: linear-gradient(180deg, #f2f8ff 0%, #e9f3ff 100%);
}

.matrix th { min-width: 290px; }
.matrix td { min-width: 290px; }

.checklist {
  margin: 0;
  padding: 0;
  list-style: none;
  display: grid;
  gap: 8px;
}

.check-item {
  border: 1px solid #dde7f1;
  border-radius: 10px;
  padding: 9px;
  background: #fff;
}

.check-item.done { background: #ebfaf6; border-color: #abdccc; }
.check-item.due { background: #fff9ee; border-color: #efd59f; }
.check-item.upcoming { background: #f1f7ff; border-color: #c8dcf8; }
.check-item.missed { background: #fff3f3; border-color: #f0c4c4; }

.check-row {
  display: grid;
  grid-template-columns: 22px 1fr;
  gap: 8px;
  align-items: start;
}

.check-row input {
  margin: 1px 0 0;
  width: 17px;
  height: 17px;
}

.check-title {
  font-weight: 700;
  line-height: 1.32;
  color: #203c5a;
}

.check-meta {
  margin-top: 6px;
  color: var(--muted);
  font-size: 12px;
}

.check-detail {
  margin-top: 6px;
  font-size: 12px;
  line-height: 1.4;
}

textarea {
  font-family: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
  min-height: 270px;
  background: #fbfdff;
}

details {
  margin-top: 14px;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 10px 12px;
  background: #fafcff;
}

summary {
  cursor: pointer;
  font-weight: 700;
  color: #274564;
}

@media (max-width: 920px) {
  .app {
    margin-top: 10px;
    padding: 0 10px;
  }

  .card {
    border-radius: 14px;
    padding: 12px;
  }

  .grid.two, .grid.three { grid-template-columns: 1fr; }
  th, td { min-width: 260px; }
  .row.between { align-items: flex-start; }
  .top p { font-size: 0.92rem; }
}

@media (max-width: 560px) {
  .top h1 { font-size: 1.55rem; }

  .actions {
    display: grid;
    grid-template-columns: 1fr;
  }

  .actions button {
    width: 100%;
    min-width: 0;
  }

  input, select, button, textarea {
    font-size: 16px;
  }

  .tabs {
    flex-direction: column;
  }
}

@media print {
  body { background: #fff; }
  .card { border: none; box-shadow: none; padding: 0; }
  .actions, .tabs, #generateBtn, #copyBtn, #copyRxBtn, #copyRxTableBtn, #printBtn, #printPdfBtn, #printPdfPage2Btn, #printPdfPage3Btn { display: none !important; }
  .table-wrap { border: 1px solid #cfd8e3; }
  th { position: static; }
}
  </style>
</head>
<body>
  <main class="app">
    <header class="top">
      <h1>Immunisation Coworker</h1>
      <p>India-focused schedule (NIS + IAP references) with optional US/AAP context notes.</p>
    </header>

    <section class="card">
      <h2>Child Details</h2>
      <div class="grid two">
        <label>Name (optional)
          <input id="name" type="text" placeholder="Child name" />
        </label>
        <label>Location (optional)
          <input id="location" type="text" placeholder="City / district" />
        </label>
      </div>

      <div class="grid two">
        <label>Sex
          <select id="sex">
            <option value="">Select</option>
            <option value="female">Female</option>
            <option value="male">Male</option>
            <option value="other">Other</option>
          </select>
        </label>
        <label>Assessment Date
          <input id="assessmentDate" type="date" />
        </label>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="dob">From DOB</button>
        <button class="tab" data-tab="age">From Age (days/months/years)</button>
      </div>

      <div id="dobPane" class="tab-pane active">
        <label>Date of Birth
          <input id="dob" type="date" />
        </label>
      </div>

      <div id="agePane" class="tab-pane">
        <div class="grid three">
          <label>Years
            <input id="ageYears" type="number" min="0" value="0" inputmode="numeric" />
          </label>
          <label>Months
            <input id="ageMonths" type="number" min="0" value="0" inputmode="numeric" />
          </label>
          <label>Days
            <input id="ageDays" type="number" min="0" value="0" inputmode="numeric" />
          </label>
        </div>
      </div>

      <div class="actions">
        <button id="generateBtn">Generate Plan</button>
      </div>
      <p id="error" class="error"></p>
    </section>

    <section id="results" class="card hidden">
      <div class="row between">
        <h2>Vaccination Plan</h2>
        <div class="actions">
          <button id="copyBtn">Copy Message</button>
          <button id="printBtn">Print</button>
          <button id="printPdfBtn">Print PDF Table</button>
        </div>
      </div>

      <div id="summaryMeta" class="meta"></div>

      <h3>Column-wise Checklist Table</h3>
      <div class="table-wrap">
        <table class="matrix">
          <thead>
            <tr>
              <th>1) NIS Mandatory (*)</th>
              <th>2) IAP Only (not in NIS)</th>
              <th>3) AAP Only (not in IAP and NIS)</th>
              <th>4) Nutritional Recommendations</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><ul id="nisList" class="checklist"></ul></td>
              <td><ul id="iapList" class="checklist"></ul></td>
              <td><ul id="aapList" class="checklist"></ul></td>
              <td><ul id="nutritionList" class="checklist"></ul></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>Prescription Brief (Next Due Dates Only)</h3>
      <div class="actions">
        <button id="copyRxBtn">Copy Prescription Brief</button>
        <button id="copyRxTableBtn">Copy Prescription Table</button>
      </div>
      <textarea id="prescriptionBrief" rows="10" readonly></textarea>
      <textarea id="prescriptionTable" rows="10" readonly></textarea>

      <h3>PDF Report Table (Preview)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Tick</th>
              <th>Vaccine</th>
              <th>Dose (Route + Preferred Site + Example Formulation)</th>
              <th>Scheduled Range</th>
              <th>Current Status</th>
              <th>If Missed, Take Between</th>
            </tr>
          </thead>
          <tbody id="pdfBody"></tbody>
        </table>
      </div>

      <h3>Supplements by Age (Tabular)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Supplement</th>
              <th>Age Applicability</th>
              <th>Recommendation (example formulation + dose)</th>
            </tr>
          </thead>
          <tbody id="supplementBody"></tbody>
        </table>
      </div>

      <h3>DPT Variant Guide (When to Use)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Vaccine Variant</th>
              <th>Advised For / Age Range</th>
              <th>Dose + Schedule</th>
              <th>Formulation Example</th>
              <th>Route + Preferred Site</th>
            </tr>
          </thead>
          <tbody id="dptVarBody"></tbody>
        </table>
      </div>

      <h3>Pneumococcal Variants (Valent-based Situations)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Vaccine</th>
              <th>Typical Situation / Indication</th>
              <th>Dose + Schedule</th>
              <th>Formulation Example</th>
              <th>Route + Site</th>
            </tr>
          </thead>
          <tbody id="pcvVarBody"></tbody>
        </table>
      </div>

      <h3>Special Situations (Including Immunocompromised)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Situation</th>
              <th>Vaccine Considerations</th>
              <th>Dose / Schedule Direction</th>
              <th>Formulation Example</th>
              <th>Route + Site</th>
            </tr>
          </thead>
          <tbody id="specialSituBody"></tbody>
        </table>
      </div>

      <h3>Dose / Administration / ILR / Variations</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Vaccine</th>
              <th>Dose</th>
              <th>Administration (route + site)</th>
              <th>ILR Storage</th>
              <th>Variation / Catch-up options</th>
            </tr>
          </thead>
          <tbody id="techBody"></tbody>
        </table>
      </div>

      <h3>AEFI and Expected Reactions (Quick Guide)</h3>
      <ul id="aefiList" class="list"></ul>

      <h3>Page 2: Pregnancy Vaccination and IFA</h3>
      <div class="actions">
        <button id="printPdfPage2Btn">Print PDF - Page 2</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Vaccine</th>
              <th>Trimester / Timing</th>
              <th>Dose + Schedule</th>
              <th>Formulation Example</th>
              <th>Route + Site</th>
              <th>Fetal / Neonatal Benefit</th>
            </tr>
          </thead>
          <tbody id="pregVaxBody"></tbody>
        </table>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Trimester</th>
              <th>Vaccination Plan</th>
              <th>Iron + Folic Acid Plan</th>
              <th>Key Notes</th>
            </tr>
          </thead>
          <tbody id="pregTrimesterBody"></tbody>
        </table>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Supplement Item</th>
              <th>Dose Recommendation</th>
              <th>Formulation Example</th>
              <th>Use Window</th>
            </tr>
          </thead>
          <tbody id="pregIfaBody"></tbody>
        </table>
      </div>

      <h3>Page 3: Passive Immunization (Age-wise)</h3>
      <div class="actions">
        <button id="printPdfPage3Btn">Print PDF - Page 3</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Life Stage</th>
              <th>Situation</th>
              <th>Passive Product</th>
              <th>Dose</th>
              <th>Formulation Example</th>
              <th>Route + Site</th>
              <th>Schedule / Timing</th>
              <th>Key Notes</th>
            </tr>
          </thead>
          <tbody id="passiveLifeBody"></tbody>
        </table>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Specific Situation</th>
              <th>Recommended Product / Approach</th>
              <th>Dose + Schedule</th>
              <th>Site / Route</th>
              <th>Formulation Example</th>
              <th>Practical Notes</th>
            </tr>
          </thead>
          <tbody id="passiveFocusBody"></tbody>
        </table>
      </div>

      <h3>Decision Matrix (Rapid Use)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Exposure / Scenario</th>
              <th>Passive Product</th>
              <th>Time Window</th>
              <th>Dose</th>
              <th>Route + Site</th>
              <th>Pair With</th>
            </tr>
          </thead>
          <tbody id="decisionMatrixBody"></tbody>
        </table>
      </div>

      <h3>Rabies Detailed Schedule (Category and Age-wise)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Age Group</th>
              <th>Exposure Category</th>
              <th>Passive Product</th>
              <th>Dose</th>
              <th>Vaccine Schedule (if indicated)</th>
              <th>Route + Site</th>
              <th>Formulation Example</th>
              <th>Key Instruction</th>
            </tr>
          </thead>
          <tbody id="rabiesDetailBody"></tbody>
        </table>
      </div>

      <h3>Copy / Print Summary</h3>
      <textarea id="message" rows="18" readonly></textarea>

      <details>
        <summary>Data Notes and Sources</summary>
        <ul>
          <li>NIS baseline and route/site details from MoHFW UIP PDF (updated 11 Dec 2025): <a href="https://mohfw.gov.in/sites/default/files/Final%20UIP%20Booklet_NIS%26covid_v11.pdf" target="_blank" rel="noopener noreferrer">MoHFW UIP booklet</a>.</li>
          <li>IAP ACVIP timetable update (Indian Pediatrics 2024 Feb;61(2):113-125): <a href="https://www.indianpediatrics.net/feb2024/feb-113-125.htm" target="_blank" rel="noopener noreferrer">IAP schedule update</a>.</li>
          <li>Background practical guidance requested: <a href="https://www.indianpediatrics.net/dec2018/dec-1066-1074.htm" target="_blank" rel="noopener noreferrer">Indian Pediatrics Dec 2018 practical immunization article</a>.</li>
          <li>US child schedule context (AAP-endorsed CDC schedule): <a href="https://www.cdc.gov/vaccines/hcp/imz-schedules/child-adolescent-age.html" target="_blank" rel="noopener noreferrer">CDC age schedule</a> and <a href="https://www.cdc.gov/vaccines/hcp/imz-schedules/child-adolescent-catch-up.html" target="_blank" rel="noopener noreferrer">CDC catch-up schedule</a>.</li>
          <li>Nutrition supplements references: <a href="https://nhm.gov.in/New_Updates_2018/NHM_Components/RMNCH_MH_Guidelines/child_health/Vit_A_Guideline.pdf" target="_blank" rel="noopener noreferrer">NHM Vitamin A guideline</a>, <a href="https://www.nhm.gov.in/New_Updates_2018/NHM_Components/NCD_National_Program/Anemia_Mukt_Bharat/AMB_Operational_Guidelines.pdf" target="_blank" rel="noopener noreferrer">AMB IFA operational guideline</a>, and <a href="https://www.cdc.gov/breastfeeding-special-circumstances/hcp/diet-micronutrients/vitamin-d.html" target="_blank" rel="noopener noreferrer">Vitamin D reference</a>.</li>
          <li>This tool is decision-support and not a replacement for pediatric clinical judgment.</li>
        </ul>
      </details>
    </section>
  </main>

  <script>
const DAY = 24 * 60 * 60 * 1000;
const TODAY = new Date();

const nisSchedule = [
  { id: "nis_bcg", vaccineKey: "bcg", vaccine: "BCG *", milestone: "At birth", startDay: 0, endDay: 365, dose: "0.1 ml", site: "Intradermal, left upper arm", storage: "ILR +2 C to +8 C; lyophilized vial with matched diluent; do not freeze." },
  { id: "nis_opv0", vaccineKey: "opv", vaccine: "OPV-0 *", milestone: "At birth", startDay: 0, endDay: 15, dose: "2 oral drops", site: "Oral", storage: "ILR +2 C to +8 C at session point; avoid heat/light exposure." },
  { id: "nis_hepb0", vaccineKey: "hepb", vaccine: "Hepatitis B birth dose *", milestone: "Within 24 hours", startDay: 0, endDay: 1, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C; do not freeze." },

  { id: "nis_dpt1", vaccineKey: "dtp", vaccine: "DPT-1 * (Pentavalent component)", milestone: "6 weeks", startDay: 42, endDay: 70, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "nis_hepb1", vaccineKey: "hepb", vaccine: "Hepatitis B-1 * (Pentavalent component)", milestone: "6 weeks", startDay: 42, endDay: 70, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "nis_hib1", vaccineKey: "hib", vaccine: "Hib-1 * (Pentavalent component)", milestone: "6 weeks", startDay: 42, endDay: 70, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C; no freezing." },
  { id: "nis_opv1", vaccineKey: "opv", vaccine: "OPV-1 *", milestone: "6 weeks", startDay: 42, endDay: 70, dose: "2 oral drops", site: "Oral", storage: "ILR +2 C to +8 C." },
  { id: "nis_ipv1", vaccineKey: "ipv", vaccine: "fIPV-1 *", milestone: "6 weeks", startDay: 42, endDay: 70, dose: "0.1 ml", site: "ID, upper arm", storage: "ILR +2 C to +8 C." },
  { id: "nis_rvv1", vaccineKey: "rvv", vaccine: "RVV-1 *", milestone: "6 weeks", startDay: 42, endDay: 70, dose: "Oral dose by brand", site: "Oral", storage: "ILR +2 C to +8 C." },
  { id: "nis_pcv1", vaccineKey: "pcv", vaccine: "PCV-1 *", milestone: "6 weeks", startDay: 42, endDay: 70, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C; do not freeze." },

  { id: "nis_dpt2", vaccineKey: "dtp", vaccine: "DPT-2 * (Pentavalent component)", milestone: "10 weeks", startDay: 70, endDay: 98, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C." },
  { id: "nis_hepb2", vaccineKey: "hepb", vaccine: "Hepatitis B-2 * (Pentavalent component)", milestone: "10 weeks", startDay: 70, endDay: 98, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C." },
  { id: "nis_hib2", vaccineKey: "hib", vaccine: "Hib-2 * (Pentavalent component)", milestone: "10 weeks", startDay: 70, endDay: 98, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C." },
  { id: "nis_opv2", vaccineKey: "opv", vaccine: "OPV-2 *", milestone: "10 weeks", startDay: 70, endDay: 98, dose: "2 oral drops", site: "Oral", storage: "ILR +2 C to +8 C." },
  { id: "nis_rvv2", vaccineKey: "rvv", vaccine: "RVV-2 *", milestone: "10 weeks", startDay: 70, endDay: 98, dose: "Oral dose by brand", site: "Oral", storage: "ILR +2 C to +8 C." },

  { id: "nis_dpt3", vaccineKey: "dtp", vaccine: "DPT-3 * (Pentavalent component)", milestone: "14 weeks", startDay: 98, endDay: 126, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C." },
  { id: "nis_hepb3", vaccineKey: "hepb", vaccine: "Hepatitis B-3 * (Pentavalent component)", milestone: "14 weeks", startDay: 98, endDay: 126, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C." },
  { id: "nis_hib3", vaccineKey: "hib", vaccine: "Hib-3 * (Pentavalent component)", milestone: "14 weeks", startDay: 98, endDay: 126, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C." },
  { id: "nis_opv3", vaccineKey: "opv", vaccine: "OPV-3 *", milestone: "14 weeks", startDay: 98, endDay: 126, dose: "2 oral drops", site: "Oral", storage: "ILR +2 C to +8 C." },
  { id: "nis_ipv2", vaccineKey: "ipv", vaccine: "fIPV-2 *", milestone: "14 weeks", startDay: 98, endDay: 126, dose: "0.1 ml", site: "ID, upper arm", storage: "ILR +2 C to +8 C." },
  { id: "nis_rvv3", vaccineKey: "rvv", vaccine: "RVV-3 *", milestone: "14 weeks", startDay: 98, endDay: 126, dose: "Oral dose by brand", site: "Oral", storage: "ILR +2 C to +8 C." },
  { id: "nis_pcv2", vaccineKey: "pcv", vaccine: "PCV-2 *", milestone: "14 weeks", startDay: 98, endDay: 126, dose: "0.5 ml", site: "IM, anterolateral thigh", storage: "ILR +2 C to +8 C; do not freeze." },

  { id: "nis_mr1", vaccineKey: "mr", vaccine: "MR-1 *", milestone: "9-12 months", startDay: 270, endDay: 365, dose: "0.5 ml", site: "SC, upper arm", storage: "ILR +2 C to +8 C before reconstitution; use matched diluent." },
  { id: "nis_je1", vaccineKey: "je", vaccine: "JE-1 (optional by region - NIS endemic/IAP)", milestone: "9-12 months", startDay: 270, endDay: 365, dose: "0.5 ml", site: "SC, upper arm", storage: "ILR +2 C to +8 C; endemic districts only." },

  { id: "nis_pcvb", vaccineKey: "pcv", vaccine: "PCV booster *", milestone: "16-24 months", startDay: 480, endDay: 730, dose: "0.5 ml", site: "IM, thigh/deltoid", storage: "ILR +2 C to +8 C." },
  { id: "nis_dptb1", vaccineKey: "dtp", vaccine: "DPT booster-1 *", milestone: "16-24 months", startDay: 480, endDay: 730, dose: "0.5 ml", site: "IM, thigh/deltoid", storage: "ILR +2 C to +8 C." },
  { id: "nis_opvb", vaccineKey: "opv", vaccine: "OPV booster *", milestone: "16-24 months", startDay: 480, endDay: 730, dose: "2 oral drops", site: "Oral", storage: "ILR +2 C to +8 C." },
  { id: "nis_mr2", vaccineKey: "mr", vaccine: "MR-2 *", milestone: "16-24 months", startDay: 480, endDay: 730, dose: "0.5 ml", site: "SC, upper arm", storage: "ILR +2 C to +8 C before reconstitution; use matched diluent." },
  { id: "nis_je2", vaccineKey: "je", vaccine: "JE-2 (optional by region - NIS endemic/IAP)", milestone: "16-24 months", startDay: 480, endDay: 730, dose: "0.5 ml", site: "SC, upper arm", storage: "ILR +2 C to +8 C." },

  { id: "nis_dptb2", vaccineKey: "dtp", vaccine: "DPT booster-2 *", milestone: "5-6 years", startDay: 5 * 365, endDay: 6 * 365, dose: "0.5 ml", site: "IM, deltoid", storage: "ILR +2 C to +8 C." },
  { id: "nis_td10", vaccineKey: "td", vaccine: "Td *", milestone: "10 years", startDay: 10 * 365, endDay: 11 * 365, dose: "0.5 ml", site: "IM, deltoid", storage: "ILR +2 C to +8 C." },
  { id: "nis_td16", vaccineKey: "td", vaccine: "Td *", milestone: "16 years", startDay: 16 * 365, endDay: 17 * 365, dose: "0.5 ml", site: "IM, deltoid", storage: "ILR +2 C to +8 C." }
];

const iapScheduleRaw = [
  { id: "iap_mmr", vaccineKey: "mmr_opt", vaccine: "MMR (optional additional - IAP)", milestone: "9 months and 15 months", startDay: 270, endDay: 550, dose: "0.5 ml", site: "SC, upper arm", storage: "ILR +2 C to +8 C before reconstitution; matched diluent required." },
  { id: "iap_var", vaccineKey: "varicella", vaccine: "Varicella (optional - IAP)", milestone: "15 months + 4-6 years", startDay: 450, endDay: 6 * 365, dose: "0.5 ml", site: "SC, upper arm", storage: "ILR +2 C to +8 C; brand-specific reconstitution." },
  { id: "iap_hepa", vaccineKey: "hepa", vaccine: "Hepatitis A (optional additional - IAP)", milestone: "12-23 months", startDay: 365, endDay: 730, dose: "0.5 ml or 1 ml by brand/age", site: "IM, anterolateral thigh/deltoid", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "iap_typhoid", vaccineKey: "typhoid", vaccine: "Typhoid conjugate vaccine (optional additional - IAP)", milestone: "9-12 months onward", startDay: 270, endDay: 18 * 365, dose: "0.5 ml", site: "IM, deltoid/thigh", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "iap_hpv", vaccineKey: "hpv", vaccine: "HPV (optional additional - IAP)", milestone: "9-14 years", startDay: 9 * 365, endDay: 15 * 365, dose: "0.5 ml", site: "IM, deltoid", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "iap_pcv_add", vaccineKey: "pcv_add", vaccine: "Pneumococcal catch-up/extended schedule (optional additional - IAP)", milestone: "6 months to 5 years", startDay: 180, endDay: 5 * 365, dose: "0.5 ml", site: "IM, thigh/deltoid", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "iap_influenza", vaccineKey: "influenza", vaccine: "Influenza annual vaccine (optional additional - IAP)", milestone: "6 months onward", startDay: 180, endDay: 18 * 365, dose: "0.25 ml or 0.5 ml by age/product", site: "IM, thigh or deltoid", storage: "ILR +2 C to +8 C; do not freeze." }
];

const aapScheduleRaw = [
  { id: "aap_menacwy", vaccineKey: "menacwy", vaccine: "Meningococcal MenACWY (optional additional - AAP)", milestone: "11-12 years", startDay: 11 * 365, endDay: 13 * 365, dose: "0.5 ml", site: "IM, deltoid", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "aap_menb", vaccineKey: "menb", vaccine: "Meningococcal MenB (optional additional - AAP)", milestone: "16-23 years (preferred 16-18)", startDay: 16 * 365, endDay: 23 * 365, dose: "0.5 ml", site: "IM, deltoid", storage: "ILR +2 C to +8 C; do not freeze." },
  { id: "aap_covid", vaccineKey: "covid", vaccine: "COVID-19 updated vaccine (optional additional - AAP)", milestone: "6 months onward", startDay: 180, endDay: 23 * 365, dose: "0.25/0.3/0.5 ml by product-age", site: "IM, thigh (small child) or deltoid", storage: "ILR +2 C to +8 C at session level after thaw/prep per brand." }
];

const catchUpAdvice = {
  bcg: "If unvaccinated and age <1 year, give at next visit.",
  hepb: "Do not restart. Catch-up usually 0, 1 month, 6 months.",
  hib: "Complete Hib catch-up using age-appropriate number of doses; no restart.",
  opv: "Continue age-appropriate OPV/IPV doses; no restart.",
  ipv: "Complete IPV catch-up with minimum 4-week interval between early doses.",
  rvv: "Do not initiate RVV beyond maximum start age as per product policy.",
  dtp: "If age <7 years, catch-up with DTwP or DTaP as available; if pertussis component contraindicated, use dT/DT. If age >=7 years, shift to Tdap then Td/dT catch-up.",
  pcv: "Use age-based PCV catch-up table; fewer doses if older.",
  pcv_add: "Use age-based PCV catch-up table (IAP additional schedule).",
  mr: "Ensure 2 measles-containing doses at least 4 weeks apart.",
  mmr_opt: "If using MMR as additional schedule, ensure age-appropriate two-dose completion.",
  je: "In endemic regions, administer pending JE doses promptly.",
  td: "For missed adolescent booster, give Td or dT now; if never received Tdap, give one Tdap dose first, then Td/dT by interval.",
  varicella: "2-dose catch-up: 3 months apart (<13 years), 4 weeks apart (>=13 years).",
  hepa: "Catch-up with inactivated schedule (typically 2 doses, 6 months apart).",
  typhoid: "Give TCV now if missed; booster by product guidance.",
  hpv: "2 doses for 9-14 years, 3 doses from 15 years onward.",
  influenza: "If first influenza vaccination in younger child, two doses may be needed 4 weeks apart; then annual dose.",
  menacwy: "Give now if in age/risk indication window.",
  menb: "Use shared clinical decision-making age window.",
  covid: "Follow latest age-specific product schedule."
};

const variationAdvice = {
  bcg: "No common brand variation in UIP; if missed and <1 year, give at next contact.",
  opv: "Where OPV unavailable or contraindicated context exists, IPV-containing schedules are used per program policy.",
  hepb: "Monovalent HepB birth dose preferred; catch-up may use monovalent or combination HepB-containing vaccines.",
  hib: "Hib can be given as monovalent or in combination formulations depending on availability.",
  ipv: "IPV can be full-dose IM or fractional ID schedule per program.",
  rvv: "Rotavirus vaccine product schedules differ (2-dose or 3-dose).",
  dtp: "Under 7 years: DTwP or DTaP options; if pertussis component cannot be used, dT/DT may be used per clinician.",
  td: "At >=7 years, use one Tdap (if not yet received), then Td or dT boosters by catch-up intervals.",
  mr: "Missed measles-containing dose may be completed with MR/MMR according to local policy and age.",
  mmr_opt: "MMR additional schedule can complement MR where policy permits.",
  je: "Product choice varies by program/endemic area; follow district/state JE policy.",
  pcv: "PCV10/PCV13 product schedules may vary; use product-consistent catch-up guidance.",
  pcv_add: "IAP additional pneumococcal scheduling depends on age and prior doses.",
  varicella: "Monovalent varicella or MMRV combinations may be used depending on age/program.",
  hepa: "Live attenuated single-dose and inactivated 2-dose options vary by brand and policy.",
  typhoid: "TCV preferred; booster recommendation varies by local policy/product.",
  hpv: "Bivalent/quadrivalent/nonavalent options exist; 2-dose (9-14y) or 3-dose (>=15y) by policy.",
  influenza: "Quadrivalent inactivated influenza products vary by age and annual strain update.",
  menacwy: "Conjugate formulations vary; booster need depends on age/risk profile.",
  menb: "Brand schedules differ (2-dose or 3-dose).",
  covid: "Dose volume/interval varies by product platform and age band."
};

const nutritionRules = [
  {
    id: "nutri_vitd",
    name: "Vitamin D",
    startDay: 0,
    endDay: 365,
    text: "Vitamin D 400 IU/day in infancy. [Common formulations: cholecalciferol oral drops 400 IU/ml or 800 IU/ml; usual dose: 1 ml of 400 IU/ml once daily OR 0.5 ml of 800 IU/ml once daily.]"
  },
  {
    id: "nutri_ifa",
    name: "IFA",
    startDay: 180,
    endDay: 59 * 30,
    text: "IFA (6-59 months) biweekly as per Anemia Mukt Bharat protocol. [Common formulations: pediatric IFA syrup; usual program dose: 1 ml biweekly providing about 20 mg elemental iron + 100 mcg folic acid.]"
  },
  {
    id: "nutri_vita",
    name: "Vitamin A",
    startDay: 270,
    endDay: 5 * 365,
    text: "Vitamin A prophylaxis from 9 months up to 5 years. [Common formulation: retinyl palmitate oral solution 100,000 IU/ml; usual dose: 1 ml (100,000 IU) at 9 months, then 2 ml (200,000 IU) every 6 months.]"
  },
  {
    id: "nutri_deworm",
    name: "Deworming",
    startDay: 365,
    endDay: 19 * 365,
    text: "Deworming every 6 months from 1 year in endemic settings. [Common formulations: albendazole suspension 200 mg/5 ml or chewable 400 mg; usual dose: 1-2 years 200 mg single dose, >=2 years 400 mg single dose.]"
  }
];

const dptVariantRows = [
  {
    variant: "DTwP",
    advised: "Primary series and boosters in children <7 years where whole-cell pertussis policy is used.",
    schedule: "0.5 ml per dose at 6, 10, 14 weeks; boosters at 16-24 months and 5-6 years (program dependent).",
    formulation: "DTwP containing vial/PFS or combination (e.g., DTwP-HepB-Hib).",
    site: "IM; anterolateral thigh in infants, deltoid in older child."
  },
  {
    variant: "DTaP",
    advised: "Alternative acellular pertussis option in children <7 years (private/IAP contexts).",
    schedule: "0.5 ml per dose; primary + booster schedule by product/program.",
    formulation: "DTaP or DTaP-based combination vial/PFS.",
    site: "IM; thigh in younger child, deltoid in older child."
  },
  {
    variant: "Tdap",
    advised: "Age >=7 years catch-up and adolescent dose; pregnancy (each pregnancy, typically 27-36 weeks) where recommended.",
    schedule: "0.5 ml IM single Tdap, then Td/dT boosters by catch-up intervals (often 0, 1 month, 6 months sequence).",
    formulation: "Reduced-antigen Tdap vial/PFS.",
    site: "IM deltoid."
  },
  {
    variant: "Td / dT",
    advised: "Age >=7 years boosters/catch-up; routine adolescent and pregnancy Td policies in some programs.",
    schedule: "0.5 ml IM; booster/catch-up per schedule and local maternal immunization policy.",
    formulation: "Td/dT toxoid vial/PFS.",
    site: "IM deltoid."
  }
];

const pcvVariantRows = [
  {
    vaccine: "PCV10 / PCV13",
    indication: "Routine infant schedule and catch-up in young children.",
    schedule: "Typical pediatric dose 0.5 ml IM; schedule by age/history (e.g., infant primary + booster).",
    formulation: "PCV10 or PCV13 vial/PFS.",
    site: "IM; thigh in infants, deltoid in older children."
  },
  {
    vaccine: "PCV15 / PCV20",
    indication: "Used in some updated schedules and risk-based pathways.",
    schedule: "0.5 ml IM; series by age and prior pneumococcal history.",
    formulation: "PCV15/PCV20 conjugate vial/PFS.",
    site: "IM; age-appropriate thigh/deltoid."
  },
  {
    vaccine: "PPSV23",
    indication: "Risk-based use in older children/adolescents and certain special conditions after PCV priming.",
    schedule: "0.5 ml IM/SC as per risk protocol and timing after PCV.",
    formulation: "PPSV23 polysaccharide vial/PFS.",
    site: "IM (preferred) or SC per label/policy."
  }
];

const specialSituationRows = [
  {
    situation: "Immunocompromised child (HIV, chemotherapy, transplant risk)",
    considerations: "Prioritize inactivated vaccines; evaluate live vaccines case-by-case with specialist.",
    schedule: "Use enhanced/risk-based schedules (e.g., pneumococcal strategy with PCV and possible PPSV23).",
    formulation: "PCV/PPSV23, influenza inactivated, other non-live products as indicated.",
    site: "Mostly IM in thigh/deltoid by age and vaccine."
  },
  {
    situation: "Asplenia / sickle cell / CSF leak / cochlear implant",
    considerations: "Higher invasive pneumococcal and meningococcal risk.",
    schedule: "Age-appropriate MenACWY/MenB and expanded pneumococcal strategy by specialist protocol.",
    formulation: "MenACWY, MenB, PCV (and PPSV23 where indicated).",
    site: "IM deltoid or thigh as per age."
  },
  {
    situation: "Preterm / low birth weight infant",
    considerations: "Follow chronological age schedule in most cases; ensure birth dose protections.",
    schedule: "Routine schedule with product-specific adjustments only when advised.",
    formulation: "Standard pediatric formulations; Vit K birth dosing may differ by weight protocol.",
    site: "IM thigh; ID/SC/oral by vaccine route."
  },
  {
    situation: "Pregnancy (maternal immunization context)",
    considerations: "Protect mother and newborn (policy may vary by country/program).",
    schedule: "Tdap usually at 27-36 weeks in many guidelines, or Td schedule per local national policy.",
    formulation: "Tdap or Td toxoid products.",
    site: "IM deltoid."
  },
  {
    situation: "Post-exposure/high-risk travel settings",
    considerations: "Accelerated or additional vaccines may be needed.",
    schedule: "Use risk-based timeline for JE, meningococcal, influenza, COVID, etc.",
    formulation: "Product and brand selected by destination/risk policy.",
    site: "Route/site depends on selected vaccine."
  }
];

const pregnancyVaccineRows = [
  {
    vaccine: "Td (NIS pregnancy)",
    timing: "Early ANC: Td-1; Td-2 after 4 weeks and at least 2 weeks before EDD",
    schedule: "0.5 ml IM each dose; booster-only approach if previously adequately immunized",
    formulation: "Td adult vial/PFS 0.5 ml",
    site: "IM deltoid",
    benefit: "Prevents maternal and neonatal tetanus"
  },
  {
    vaccine: "Tdap (every pregnancy)",
    timing: "Preferred 27-36 weeks (earlier in this window favored)",
    schedule: "Single 0.5 ml IM dose in each pregnancy; can be earlier for special indications",
    formulation: "Tdap 0.5 ml (example: Boostrix, Adacel)",
    site: "IM deltoid",
    benefit: "Passive pertussis antibodies to newborn; reduces severe infant pertussis"
  },
  {
    vaccine: "Inactivated Influenza",
    timing: "Any trimester during influenza season",
    schedule: "Single seasonal dose (0.5 ml IM in most products)",
    formulation: "Trivalent/quadrivalent inactivated influenza vaccine",
    site: "IM deltoid",
    benefit: "Reduces maternal severe flu and risk of preterm/LBW; partial infant protection"
  },
  {
    vaccine: "Hepatitis B (risk-based)",
    timing: "Any trimester if non-immune or high-risk",
    schedule: "0, 1, 6 month schedule",
    formulation: "Recombinant Hepatitis B adult formulation (1 ml IM)",
    site: "IM deltoid",
    benefit: "Reduces perinatal HBV transmission with newborn prophylaxis"
  },
  {
    vaccine: "Other inactivated risk-based vaccines",
    timing: "Case-by-case in pregnancy",
    schedule: "Use exposure-risk protocol (e.g., rabies, Hep A, typhoid, COVID by current policy)",
    formulation: "Inactivated formulations only in routine pregnancy context",
    site: "Route/site by product label",
    benefit: "Prevents severe maternal infection and downstream fetal/neonatal risk"
  }
];

const pregnancyTrimesterRows = [
  {
    trimester: "1st trimester (0-12 weeks)",
    vaxPlan: "Influenza can be given if season/risk; Td if due; Tdap usually deferred to 27-36 weeks unless special indication",
    ifaPlan: "Folic acid priority: 0.4 mg/day for all; high-risk NTD cases 4-5 mg/day. Start/continue iron as tolerated",
    notes: "Neural tube closes very early; folate timing is critical"
  },
  {
    trimester: "2nd trimester (13-27 weeks)",
    vaxPlan: "Complete pending Td series; give influenza if not yet given",
    ifaPlan: "Routine prophylaxis: elemental iron 60 mg + folic acid 400 mcg daily; escalate if anemia",
    notes: "If oral intolerance significant, consider dose timing/interval adjustments under clinician guidance"
  },
  {
    trimester: "3rd trimester (28 weeks-delivery)",
    vaxPlan: "Tdap single dose in 27-36 weeks window; continue indicated inactivated vaccines",
    ifaPlan: "Continue 60 mg elemental iron + 400 mcg folic acid daily; consider IV iron if persistent anemia and limited time",
    notes: "Maximize transplacental antibodies and optimize maternal iron stores before birth"
  }
];

const pregnancyIfaRows = [
  {
    item: "Prophylaxis (routine pregnancy)",
    dose: "Elemental iron 60 mg + folic acid 400 mcg once daily",
    formulation: "IFA tablet: 60 mg elemental iron (often ferrous fumarate/sulfate) + 400-500 mcg folic acid",
    window: "From first ANC through pregnancy (often continued >=3 months postpartum)"
  },
  {
    item: "High-risk folate (NTD risk)",
    dose: "Folic acid 4-5 mg once daily, then step-down to 0.4 mg/day after 1st trimester",
    formulation: "Folic acid 5 mg tablet",
    window: "Preconception to 12 weeks gestation"
  },
  {
    item: "Therapeutic oral iron (anemia)",
    dose: "Elemental iron 100-200 mg/day + folic acid 400-500 mcg/day",
    formulation: "Example: ferrous sulfate 200 mg TDS (~180 mg elemental iron/day total) + folic acid",
    window: "When Hb suggests mild-moderate IDA, per protocol"
  },
  {
    item: "IV iron (selected cases)",
    dose: "Calculated total iron replacement dose after 13 weeks",
    formulation: "Iron sucrose / ferric carboxymaltose (product-specific dosing)",
    window: "Moderate-severe anemia, oral intolerance, malabsorption, or late gestation correction"
  },
  {
    item: "Elemental iron equivalence examples",
    dose: "Ferrous sulfate 300 mg ~60 mg elemental; ferrous fumarate 200 mg ~65 mg elemental; ferrous gluconate 500 mg ~60 mg elemental",
    formulation: "Salt-specific tablet formulations",
    window: "For selecting equivalent prophylactic daily dose"
  }
];

const passiveLifecycleRows = [
  {
    stage: "Antenatal (pregnancy)",
    situation: "Tetanus-prone wound",
    product: "TIG",
    dose: "250-500 IU IM",
    formulation: "HyperTET / BayTet",
    routeSite: "IM deltoid or anterolateral thigh",
    timing: "Single dose ASAP post-injury (up to ~21 days)",
    notes: "Give with Td/Tdap at separate site if indicated."
  },
  {
    stage: "Antenatal (pregnancy)",
    situation: "Hepatitis B exposure",
    product: "HBIG",
    dose: "0.06 mL/kg IM (or fixed ~500 IU by protocol)",
    formulation: "HyperHEP B / HepaGam B",
    routeSite: "IM deltoid",
    timing: "Prefer within 48 h (up to 14 days reduced efficacy)",
    notes: "Combine with Hep B vaccine series at separate site."
  },
  {
    stage: "Natal/Postnatal/Neonatal",
    situation: "Infant of HBsAg-positive mother",
    product: "HBIG + Hep B vaccine",
    dose: "HBIG 0.5 mL IM + Hep B birth dose",
    formulation: "HBIG pediatric vial + recombinant Hep B vaccine",
    routeSite: "IM anterolateral thigh (separate sites)",
    timing: "Within 12 h of birth (ideally), acceptable up to 24 h",
    notes: "Critical to prevent perinatal HBV transmission."
  },
  {
    stage: "Neonatal/Infancy",
    situation: "RSV seasonal prevention",
    product: "Nirsevimab (mAb)",
    dose: "<5 kg: 50 mg IM; >=5 kg: 100 mg IM; selected high-risk second season: 200 mg",
    formulation: "Beyfortus prefilled product",
    routeSite: "IM anterolateral thigh",
    timing: "Single dose per season window",
    notes: "Passive monoclonal antibody, not active vaccine."
  },
  {
    stage: "Infancy/Toddler/Childhood/Adolescence/Adult",
    situation: "Rabies category III exposure",
    product: "HRIG + Rabies vaccine",
    dose: "HRIG 20 IU/kg once (Day 0) + vaccine series",
    formulation: "HyperRAB / Imogam Rabies",
    routeSite: "Infiltrate wounds; remainder IM distant site",
    timing: "Day 0 with first vaccine; do not give HRIG after Day 7",
    notes: "Do not exceed HRIG dose; thorough wound washing mandatory."
  },
  {
    stage: "Infancy/Toddler/Childhood/Adolescence/Adult",
    situation: "Measles exposure high-risk",
    product: "IGIM or IVIg",
    dose: "IGIM 0.5 mL/kg (max 15 mL) or IVIg 400 mg/kg in immunocompromised",
    formulation: "GamaSTAN / IVIg brands",
    routeSite: "IM large muscle (split doses) or IV infusion",
    timing: "Within 6 days of exposure",
    notes: "May delay live measles/MMR schedule afterward."
  },
  {
    stage: "Infancy to Adult (high-risk only)",
    situation: "Varicella significant exposure (susceptible high-risk)",
    product: "VariZIG",
    dose: "125 IU per 10 kg IM (max 625 IU)",
    formulation: "VariZIG",
    routeSite: "IM deltoid/thigh",
    timing: "Within 96 h preferred; up to 10 days",
    notes: "Especially for pregnancy/immunocompromised settings."
  }
];

const passiveFocusRows = [
  {
    situation: "HIV exposure (all ages)",
    approach: "Not passive immunization: use ART-based PEP",
    doseSchedule: "28-day regimen; initiate within 72 h (ideally earlier)",
    siteRoute: "Oral medications",
    formulation: "Tenofovir/emtricitabine + integrase inhibitor (example regimen)",
    notes: "Baseline and follow-up HIV testing required."
  },
  {
    situation: "Hepatitis B exposure",
    approach: "HBIG +/- Hep B vaccine by immunity status",
    doseSchedule: "HBIG 0.06 mL/kg IM ASAP + start/complete vaccine series if needed",
    siteRoute: "IM deltoid (separate site from vaccine)",
    formulation: "HyperHEP B / Nabi-HB + recombinant Hep B vaccine",
    notes: "If anti-HBs >=10 mIU/mL, HBIG often not needed."
  },
  {
    situation: "Rabies category II/III",
    approach: "Vaccine +/- HRIG by category",
    doseSchedule: "Category II: vaccine schedule; Category III: HRIG 20 IU/kg Day 0 + vaccine",
    siteRoute: "Wound infiltration + IM distant site",
    formulation: "HRIG: HyperRAB / Imogam + cell-culture rabies vaccine",
    notes: "Never exceed HRIG dose; no HRIG after Day 7."
  },
  {
    situation: "Immunocompromised exposure management",
    approach: "Lower threshold for passive products; often prefer IVIg in measles exposure",
    doseSchedule: "Example measles IVIg 400 mg/kg; product-specific follow-up",
    siteRoute: "IV infusion (or IM based on product)",
    formulation: "IVIg preparations; disease-specific IG where available",
    notes: "Specialist-guided scheduling and live-vaccine defer intervals required."
  }
];

const decisionMatrixRows = [
  {
    exposure: "HBsAg-positive mother -> newborn",
    product: "HBIG",
    window: "Within 12 hours of birth",
    dose: "0.5 mL IM",
    routeSite: "IM anterolateral thigh",
    pairWith: "Hep B birth vaccine at separate site"
  },
  {
    exposure: "Hepatitis B blood/sexual exposure",
    product: "HBIG",
    window: "Prefer <=48 h (up to 7-14 days reduced efficacy)",
    dose: "0.06 mL/kg IM",
    routeSite: "IM deltoid",
    pairWith: "Start/complete Hep B vaccine series"
  },
  {
    exposure: "Rabies category III exposure",
    product: "HRIG",
    window: "Day 0 only (not after Day 7 of vaccine)",
    dose: "20 IU/kg once",
    routeSite: "Infiltrate all wounds, remainder IM distant site",
    pairWith: "Rabies vaccine schedule"
  },
  {
    exposure: "Tetanus-prone dirty wound, under-immunized",
    product: "TIG",
    window: "ASAP post-injury",
    dose: "250-500 IU IM",
    routeSite: "IM deltoid/thigh",
    pairWith: "Td/Tdap at separate site"
  },
  {
    exposure: "Varicella high-risk susceptible exposure",
    product: "VariZIG",
    window: "Within 96 h preferred (up to 10 days)",
    dose: "125 IU per 10 kg IM (max 625 IU)",
    routeSite: "IM deltoid/thigh",
    pairWith: "Clinical monitoring; consider antiviral if breakthrough"
  },
  {
    exposure: "Measles high-risk exposure",
    product: "IGIM / IVIg",
    window: "Within 6 days of exposure",
    dose: "IGIM 0.5 mL/kg (max 15 mL) OR IVIg 400 mg/kg",
    routeSite: "IM split sites or IV infusion",
    pairWith: "Live vaccine defer interval as applicable"
  },
  {
    exposure: "RSV prophylaxis in eligible infant",
    product: "Nirsevimab",
    window: "At season entry / birth in season",
    dose: "<5 kg 50 mg IM; >=5 kg 100 mg IM",
    routeSite: "IM anterolateral thigh",
    pairWith: "Routine childhood vaccines can continue"
  },
  {
    exposure: "HIV high-risk exposure",
    product: "No passive IG (ART PEP)",
    window: "<=72 h (ideally sooner)",
    dose: "28-day ART regimen",
    routeSite: "Oral",
    pairWith: "Baseline + follow-up HIV testing"
  }
];

const rabiesDetailRows = [
  {
    age: "Neonatal/Infancy",
    category: "Category I",
    passive: "None",
    dose: "No HRIG",
    vaccine: "No vaccine",
    routeSite: "Not applicable",
    formulation: "Not applicable",
    instruction: "Touching/feeding animal or licks on intact skin = no exposure treatment."
  },
  {
    age: "Neonatal/Infancy",
    category: "Category II",
    passive: "Usually no HRIG",
    dose: "No HRIG",
    vaccine: "Rabies vaccine Day 0, 3, 7, 14",
    routeSite: "Vaccine IM anterolateral thigh (or deltoid if age-appropriate)",
    formulation: "Cell-culture rabies vaccine vial/PFS",
    instruction: "Immediate wound washing + complete vaccine course."
  },
  {
    age: "Neonatal/Infancy",
    category: "Category III",
    passive: "HRIG",
    dose: "20 IU/kg once on Day 0",
    vaccine: "Rabies vaccine Day 0, 3, 7, 14 (plus Day 28 in selected protocols)",
    routeSite: "Infiltrate wounds; remainder IM distant site (thigh/deltoid)",
    formulation: "HyperRAB / Imogam Rabies (or equivalent HRIG)",
    instruction: "Do not exceed HRIG dose; do not give HRIG after Day 7."
  },
  {
    age: "Toddler/Childhood/Adolescence",
    category: "Category II",
    passive: "No HRIG (unless protocol exceptions)",
    dose: "No HRIG",
    vaccine: "Rabies vaccine Day 0, 3, 7, 14",
    routeSite: "IM deltoid preferred; anterolateral thigh in younger child",
    formulation: "CCV/PVRV rabies vaccine",
    instruction: "Category II is vaccine-only in standard protocols."
  },
  {
    age: "Toddler/Childhood/Adolescence",
    category: "Category III",
    passive: "HRIG mandatory",
    dose: "20 IU/kg once on Day 0",
    vaccine: "Rabies vaccine Day 0, 3, 7, 14 (Â± Day 28 by policy)",
    routeSite: "Infiltrate all wounds; remainder IM distant site",
    formulation: "HRIG vial + rabies vaccine",
    instruction: "Never mix HRIG and vaccine in same syringe/site."
  },
  {
    age: "Adults",
    category: "Category II",
    passive: "Usually no HRIG",
    dose: "No HRIG",
    vaccine: "Rabies vaccine Day 0, 3, 7, 14",
    routeSite: "IM deltoid",
    formulation: "Cell-culture rabies vaccine",
    instruction: "Prompt wound toilet remains critical."
  },
  {
    age: "Adults",
    category: "Category III",
    passive: "HRIG mandatory",
    dose: "20 IU/kg once on Day 0",
    vaccine: "Rabies vaccine Day 0, 3, 7, 14 (Â± Day 28 for immunocompromised/high-risk protocols)",
    routeSite: "Infiltrate wound(s); remainder IM deltoid/thigh at distant site",
    formulation: "HyperRAB / Imogam Rabies + vaccine",
    instruction: "If no visible wound, administer full HRIG dose IM at distant site."
  }
];

const els = {
  tabs: document.querySelectorAll(".tab"),
  dobPane: document.getElementById("dobPane"),
  agePane: document.getElementById("agePane"),
  dob: document.getElementById("dob"),
  ageYears: document.getElementById("ageYears"),
  ageMonths: document.getElementById("ageMonths"),
  ageDays: document.getElementById("ageDays"),
  assessmentDate: document.getElementById("assessmentDate"),
  sex: document.getElementById("sex"),
  name: document.getElementById("name"),
  location: document.getElementById("location"),
  generateBtn: document.getElementById("generateBtn"),
  error: document.getElementById("error"),
  results: document.getElementById("results"),
  summaryMeta: document.getElementById("summaryMeta"),
  nisList: document.getElementById("nisList"),
  iapList: document.getElementById("iapList"),
  aapList: document.getElementById("aapList"),
  nutritionList: document.getElementById("nutritionList"),
  techBody: document.getElementById("techBody"),
  message: document.getElementById("message"),
  prescriptionBrief: document.getElementById("prescriptionBrief"),
  prescriptionTable: document.getElementById("prescriptionTable"),
  pdfBody: document.getElementById("pdfBody"),
  supplementBody: document.getElementById("supplementBody"),
  dptVarBody: document.getElementById("dptVarBody"),
  pcvVarBody: document.getElementById("pcvVarBody"),
  specialSituBody: document.getElementById("specialSituBody"),
  pregVaxBody: document.getElementById("pregVaxBody"),
  pregTrimesterBody: document.getElementById("pregTrimesterBody"),
  pregIfaBody: document.getElementById("pregIfaBody"),
  passiveLifeBody: document.getElementById("passiveLifeBody"),
  passiveFocusBody: document.getElementById("passiveFocusBody"),
  decisionMatrixBody: document.getElementById("decisionMatrixBody"),
  rabiesDetailBody: document.getElementById("rabiesDetailBody"),
  aefiList: document.getElementById("aefiList"),
  copyBtn: document.getElementById("copyBtn"),
  copyRxBtn: document.getElementById("copyRxBtn"),
  copyRxTableBtn: document.getElementById("copyRxTableBtn"),
  printBtn: document.getElementById("printBtn"),
  printPdfBtn: document.getElementById("printPdfBtn"),
  printPdfPage2Btn: document.getElementById("printPdfPage2Btn"),
  printPdfPage3Btn: document.getElementById("printPdfPage3Btn")
};

const state = {
  tab: "dob",
  ageDays: 0,
  dob: null,
  assessmentDate: null,
  checked: {}
};

init();

function init() {
  els.assessmentDate.value = toDateInput(TODAY);
  els.tabs.forEach((tab) => tab.addEventListener("click", () => switchTab(tab.dataset.tab)));
  if (els.generateBtn) els.generateBtn.addEventListener("click", generatePlan);
  if (els.copyBtn) els.copyBtn.addEventListener("click", copyMessage);
  if (els.copyRxBtn) els.copyRxBtn.addEventListener("click", copyPrescriptionBrief);
  if (els.copyRxTableBtn) els.copyRxTableBtn.addEventListener("click", copyPrescriptionTable);
  if (els.printBtn) els.printBtn.addEventListener("click", doPrint);
  if (els.printPdfBtn) els.printPdfBtn.addEventListener("click", printPdfReport);
  if (els.printPdfPage2Btn) els.printPdfPage2Btn.addEventListener("click", printPdfPage2);
  if (els.printPdfPage3Btn) els.printPdfPage3Btn.addEventListener("click", printPdfPage3);
}

function switchTab(tabName) {
  state.tab = tabName;
  els.tabs.forEach((tab) => tab.classList.toggle("active", tab.dataset.tab === tabName));
  els.dobPane.classList.toggle("active", tabName === "dob");
  els.agePane.classList.toggle("active", tabName === "age");
}

function generatePlan() {
  els.error.textContent = "";
  const assessmentDate = parseDate(els.assessmentDate.value);
  if (!assessmentDate) {
    els.error.textContent = "Please select an assessment date.";
    return;
  }

  let dob;
  let ageDays;

  if (state.tab === "dob") {
    dob = parseDate(els.dob.value);
    if (!dob) {
      els.error.textContent = "Please enter date of birth.";
      return;
    }
    ageDays = Math.floor((assessmentDate - dob) / DAY);
    if (ageDays < 0) {
      els.error.textContent = "Date of birth cannot be after assessment date.";
      return;
    }
  } else {
    const y = Number(els.ageYears.value || 0);
    const m = Number(els.ageMonths.value || 0);
    const d = Number(els.ageDays.value || 0);
    ageDays = y * 365 + m * 30 + d;
    dob = new Date(assessmentDate.getTime() - ageDays * DAY);
  }

  state.assessmentDate = assessmentDate;
  state.dob = dob;
  state.ageDays = ageDays;

  ensureCheckKeys();
  renderAll();
  els.results.classList.remove("hidden");
}

function ensureCheckKeys() {
  const lists = getLists();
  [...lists.nis, ...lists.iap, ...lists.aap, ...nutritionRules].forEach((item) => {
    if (typeof state.checked[item.id] === "undefined") state.checked[item.id] = false;
  });
}

function getLists() {
  const nis = [...nisSchedule].sort((a, b) => a.startDay - b.startDay);
  const nisKeys = new Set(nis.map((x) => x.vaccineKey));

  const iap = iapScheduleRaw
    .filter((x) => !nisKeys.has(x.vaccineKey))
    .sort((a, b) => a.startDay - b.startDay);

  const iapKeys = new Set(iap.map((x) => x.vaccineKey));

  const aap = aapScheduleRaw
    .filter((x) => !nisKeys.has(x.vaccineKey) && !iapKeys.has(x.vaccineKey))
    .sort((a, b) => a.startDay - b.startDay);

  return { nis, iap, aap };
}

function renderAll() {
  const lists = getLists();
  const name = (els.name.value || "Child").trim();
  const sex = (els.sex.value || "not specified").trim();
  const location = (els.location.value || "not specified").trim();

  els.summaryMeta.textContent = `${name} | Sex: ${sex} | Location: ${location} | Age: ${toAgeString(state.ageDays)} | Assessment: ${fmt(state.assessmentDate)} | DOB used: ${fmt(state.dob)}`;

  renderChecklistColumn(els.nisList, lists.nis, "vaccine");
  renderChecklistColumn(els.iapList, lists.iap, "vaccine");
  renderChecklistColumn(els.aapList, lists.aap, "vaccine");
  renderChecklistColumn(els.nutritionList, nutritionRules, "nutrition");
  renderTechTable(lists);

  buildMessage(name, sex, location, lists);
  buildPrescriptionBrief(name, sex, lists);
  buildPrescriptionTable(name, sex, lists);
  buildPdfPreviewTable(lists);
  buildSupplementTable();
  buildReferenceTables();
  buildPregnancyTables();
  buildPassiveTables();
  renderAefiSection();
}

function renderChecklistColumn(target, items, type) {
  target.innerHTML = "";
  if (!items.length) {
    const li = document.createElement("li");
    li.textContent = "No items in this column.";
    target.appendChild(li);
    return;
  }

  items.forEach((item) => {
    const status = getStatus(item, type);

    const li = document.createElement("li");
    li.className = `check-item ${status.kind}`;

    const row = document.createElement("div");
    row.className = "check-row";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = !!state.checked[item.id];
    checkbox.addEventListener("change", () => {
      state.checked[item.id] = checkbox.checked;
      renderAll();
    });

    const title = document.createElement("div");
    title.className = "check-title";
    title.textContent = type === "nutrition" ? item.name : item.vaccine;

    row.appendChild(checkbox);
    row.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "check-meta";
    if (type === "nutrition") {
      meta.textContent = `${status.text} | Window: ${fmt(addDays(state.dob, item.startDay))} to ${fmt(addDays(state.dob, item.endDay))}`;
    } else {
      meta.textContent = `${item.milestone} | ${status.text} | Range: ${fmt(addDays(state.dob, item.startDay))} to ${fmt(addDays(state.dob, item.endDay))}`;
    }

    li.appendChild(row);
    li.appendChild(meta);
    if (type === "nutrition") {
      const detail = document.createElement("div");
      detail.className = "check-detail";
      detail.textContent = item.text;
      li.appendChild(detail);
    }
    target.appendChild(li);
  });
}

function getCatchUpText(item) {
  const generic = catchUpAdvice[item.vaccineKey] || "Use age-appropriate catch-up without restarting valid doses.";
  const variation = getVariationAdvice(item.vaccineKey);
  return variation ? `${generic} ${variation}` : generic;
}

function getVariationAdvice(vaccineKey) {
  if (vaccineKey === "dtp" || vaccineKey === "td") {
    if (state.ageDays < 7 * 365) return variationAdvice[vaccineKey];
    return "At age 7 years or more: one Tdap first, then Td/dT boosters (typically 0, 1 month, 6 months).";
  }
  return variationAdvice[vaccineKey] || "";
}

function getNextDuePlan(item) {
  const today = fmt(state.assessmentDate);
  const plus4w = fmt(addDays(state.assessmentDate, 28));
  const plus8w = fmt(addDays(state.assessmentDate, 56));
  const plus3m = fmt(addDays(state.assessmentDate, 90));
  const plus6m = fmt(addDays(state.assessmentDate, 180));

  switch (item.vaccineKey) {
    case "dtp":
      if (state.ageDays < 7 * 365) {
        return `Next due: ${today} (use DTwP or DTaP as age-eligible). Follow-up dose(s): ${plus4w} and then ${plus8w} if primary series incomplete.`;
      }
      return `Next due: ${today} (use Tdap first). Follow-up: Td/dT on ${plus4w}, then final Td/dT on ${plus6m}.`;
    case "hib":
      return `Next due: ${today} (Hib catch-up now). Follow-up by age schedule, often after 4-8 weeks (${plus4w} to ${plus8w}).`;
    case "ipv":
      return `Next due: ${today} (IPV/fIPV catch-up now). Follow-up after minimum 4 weeks (${plus4w}).`;
    case "rvv":
      return `Next due: only if within product age window; if eligible give now, otherwise skip and continue other vaccines.`;
    case "td":
      return `Next due: ${today} (Td/dT; if no prior Tdap, use one Tdap first). Follow-up: ${plus4w} and ${plus6m}.`;
    case "hepb":
      return `Next due: ${today} (HepB dose-1). Follow-up: dose-2 on ${plus4w}, dose-3 on ${plus6m}.`;
    case "mr":
      return `Next due: ${today} (MR/MMR dose now). Follow-up second measles-containing dose on ${plus4w}.`;
    case "pcv":
      return `Next due: ${today} (age-appropriate PCV catch-up dose). Follow-up often after about 8 weeks (${plus8w}) if additional dose required.`;
    case "pcv_add":
      return `Next due: ${today} (IAP additional pneumococcal catch-up dose). Follow-up by age and prior-dose history.`;
    case "mmr_opt":
      return `Next due: ${today} (MMR additional dose). Follow-up second dose after at least 4 weeks (${plus4w}) if pending.`;
    case "varicella":
      if (state.ageDays < 13 * 365) return `Next due: ${today} (Varicella dose-1). Follow-up dose-2 on ${plus3m}.`;
      return `Next due: ${today} (Varicella dose-1). Follow-up dose-2 on ${plus4w}.`;
    case "hepa":
      return `Next due: ${today} (HepA dose-1). Follow-up dose-2 on ${plus6m}.`;
    case "hpv":
      if (state.ageDays < 15 * 365) return `Next due: ${today} (HPV dose-1). Follow-up dose-2 on ${plus6m}.`;
      return `Next due: ${today} (HPV dose-1). Follow-up dose-2 on ${plus4w} and dose-3 on ${plus6m}.`;
    case "influenza":
      return `Next due: ${today} (seasonal influenza dose). If first season in young child, second dose after 4 weeks (${plus4w}); then annual dose.`;
    case "typhoid":
      return `Next due: ${today} (TCV catch-up dose now). Booster thereafter as per product/local policy.`;
    case "opv":
      return `Next due: ${today} (age-appropriate OPV/IPV catch-up dose now). Subsequent dose after at least 4 weeks (${plus4w}).`;
    case "bcg":
      return `Next due: ${today} if age <1 year and no contraindication; otherwise discuss non-eligibility with clinician.`;
    case "je":
      return `Next due: ${today} in endemic area program; second dose by local JE policy window.`;
    case "menacwy":
      return `Next due: ${today} if indicated; booster schedule depends on age/risk category.`;
    case "menb":
      return `Next due: ${today} if indicated; next dose interval depends on selected brand schedule.`;
    case "covid":
      return `Next due: ${today} with age-product specific dose; follow-up interval per current product guidance.`;
    default:
      return `Next due: ${today} (age-appropriate catch-up at this visit).`;
  }
}

function renderTechTable(lists) {
  const all = [...lists.nis, ...lists.iap, ...lists.aap];
  els.techBody.innerHTML = "";
  all.forEach((item) => {
    const tr = document.createElement("tr");
    const tdVaccine = document.createElement("td");
    tdVaccine.textContent = item.vaccine;
    const tdDose = document.createElement("td");
    tdDose.textContent = item.dose || "As per product label";
    const tdSite = document.createElement("td");
    tdSite.textContent = item.site || "Age-appropriate route/site";
    const tdStorage = document.createElement("td");
    tdStorage.textContent = item.storage || "Store +2 C to +8 C in ILR";
    const tdVar = document.createElement("td");
    tdVar.textContent = `${getCatchUpText(item)} ${getNextDuePlan(item)}`;
    tr.appendChild(tdVaccine);
    tr.appendChild(tdDose);
    tr.appendChild(tdSite);
    tr.appendChild(tdStorage);
    tr.appendChild(tdVar);
    els.techBody.appendChild(tr);
  });
}

function getStatus(item, type) {
  if (state.checked[item.id]) return { kind: "done", text: "Completed" };

  const start = item.startDay;
  const end = item.endDay;

  if (state.ageDays < start) return { kind: "upcoming", text: "Due later" };
  if (state.ageDays >= start && state.ageDays <= end) return { kind: "due", text: "Due now" };

  if (type === "nutrition") return { kind: "missed", text: "Age-window passed" };
  return { kind: "missed", text: "Missed - catch-up needed" };
}

function buildMessage(name, sex, location, lists) {
  const lines = [
    "IMMUNISATION COWORKER SUMMARY",
    `Name: ${name}`,
    `Sex: ${sex}`,
    `Location: ${location}`,
    `Assessment date: ${fmt(state.assessmentDate)}`,
    `DOB used: ${fmt(state.dob)} (Age: ${toAgeString(state.ageDays)})`,
    ""
  ];

  appendSection(lines, "NIS Mandatory (*)", lists.nis, "vaccine");
  appendSection(lines, "IAP Only (not in NIS)", lists.iap, "vaccine");
  appendSection(lines, "AAP Only (not in IAP and NIS)", lists.aap, "vaccine");
  appendSection(lines, "Nutritional Recommendations", nutritionRules, "nutrition");
  appendTechSection(lines, lists);
  appendAefiSection(lines);

  lines.push("Clinical note: Validate final plan with pediatrician/local program updates.");
  els.message.value = lines.join("\n");
}

function appendSection(lines, title, items, type) {
  lines.push(`${title}:`);

  const completed = [];
  const pending = [];

  items.forEach((item) => {
    const status = getStatus(item, type);
    const range = `${fmt(addDays(state.dob, item.startDay))} to ${fmt(addDays(state.dob, item.endDay))}`;
    const label = type === "nutrition" ? item.name : item.vaccine;

    if (state.checked[item.id]) {
      completed.push(`- ${label}: Completed`);
    } else if (status.kind === "due") {
      pending.push(`- ${label}: Due now (next range ${range})`);
    } else if (status.kind === "upcoming") {
      pending.push(`- ${label}: Due later (next range ${range})`);
    } else {
      const extra = type === "nutrition"
        ? "window passed"
        : `window ended ${fmt(addDays(state.dob, item.endDay))}; catch-up: ${getCatchUpText(item)} ${getNextDuePlan(item)}`;
      pending.push(`- ${label}: Pending (${extra})`);
    }
  });

  lines.push("Completed:");
  lines.push(...(completed.length ? completed : ["- None"]));
  lines.push("Due / Pending with next range:");
  lines.push(...(pending.length ? pending : ["- None"]));
  lines.push("");
}

function appendTechSection(lines, lists) {
  lines.push("Dose / Administration / ILR / Variations:");
  [...lists.nis, ...lists.iap, ...lists.aap].forEach((item) => {
    lines.push(`- ${item.vaccine}: Dose=${item.dose}; Administration=${item.site}; ILR=${item.storage}; Variation=${getCatchUpText(item)}; Missed-next-due=${getNextDuePlan(item)}`);
  });
  lines.push("");
}

function appendAefiSection(lines) {
  lines.push("AEFI and expected post-vaccination reactions:");
  getAefiLines().forEach((line) => {
    lines.push(`- ${line}`);
  });
  lines.push("");
}

function buildPrescriptionBrief(name, sex, lists) {
  const sortedEntries = getPrescriptionEntries(lists);
  const lines = [
    "PRESCRIPTION BRIEF - NEXT DUE VACCINES",
    `Name: ${name}`,
    `Sex: ${sex}`,
    `Assessment date: ${fmt(state.assessmentDate)}`,
    `DOB used: ${fmt(state.dob)} (Age: ${toAgeString(state.ageDays)})`,
    ""
  ];

  lines.push("Next due range of dates:");
  lines.push(...(sortedEntries.length
    ? sortedEntries.map((entry) => `- ${entry.vaccine}: ${entry.rangeLabel}`)
    : ["- No pending vaccines."]));
  els.prescriptionBrief.value = lines.join("\n");
}

function copyMessage() {
  copyWithFallback(els.message.value, els.message, els.copyBtn, "Clipboard access failed. Select text manually to copy.");
}

function copyPrescriptionBrief() {
  copyWithFallback(
    els.prescriptionBrief.value,
    els.prescriptionBrief,
    els.copyRxBtn,
    "Clipboard access failed for prescription brief. Select text manually to copy."
  );
}

function copyPrescriptionTable() {
  copyWithFallback(
    els.prescriptionTable.value,
    els.prescriptionTable,
    els.copyRxTableBtn,
    "Clipboard access failed for prescription table. Select text manually to copy."
  );
}

function buildPrescriptionTable(name, sex, lists) {
  const sortedEntries = getPrescriptionEntries(lists);
  const lines = [
    "PRESCRIPTION TABLE - NEXT DUE VACCINES",
    `Name: ${name} | Sex: ${sex} | Assessment: ${fmt(state.assessmentDate)} | Age: ${toAgeString(state.ageDays)}`,
    "",
    "| From Date | To Date | Vaccine |",
    "|---|---|---|"
  ];

  if (!sortedEntries.length) {
    lines.push("| - | - | No pending vaccines |");
  } else {
    sortedEntries.forEach((entry) => {
      lines.push(`| ${entry.from} | ${entry.to} | ${entry.vaccine} |`);
    });
  }
  els.prescriptionTable.value = lines.join("\n");
}

function getPrescriptionEntries(lists) {
  const allVaccines = [...lists.nis, ...lists.iap, ...lists.aap];
  const entries = [];

  allVaccines.forEach((item) => {
    if (state.checked[item.id]) return;
    const status = getStatus(item, "vaccine");
    let fromDate;
    let toDate;
    let rangeLabel;
    if (status.kind === "missed") {
      fromDate = state.assessmentDate;
      toDate = addDays(state.assessmentDate, 14);
      rangeLabel = `${fmt(fromDate)} to ${fmt(toDate)} (catch-up window)`;
    } else {
      fromDate = addDays(state.dob, item.startDay);
      toDate = addDays(state.dob, item.endDay);
      rangeLabel = `${fmt(fromDate)} to ${fmt(toDate)}`;
    }
    entries.push({
      vaccine: item.vaccine,
      fromDate,
      toDate,
      from: fmt(fromDate),
      to: fmt(toDate),
      rangeLabel
    });
  });

  entries.sort((a, b) => a.fromDate - b.fromDate || a.toDate - b.toDate || a.vaccine.localeCompare(b.vaccine));
  return entries;
}

function getPdfRows(lists) {
  const allVaccines = [...nisSchedule, ...iapScheduleRaw, ...aapScheduleRaw];
  const byId = new Map();
  allVaccines.forEach((v) => byId.set(v.id, v));
  const fullList = [...byId.values()];
  const rows = fullList.map((item) => {
    const status = getStatus(item, "vaccine");
    const scheduledFrom = addDays(state.dob, item.startDay);
    const scheduledTo = addDays(state.dob, item.endDay);
    const isDone = !!state.checked[item.id];
    const missedFrom = status.kind === "missed" ? state.assessmentDate : null;
    const missedTo = status.kind === "missed" ? addDays(state.assessmentDate, 14) : null;
    return {
      tick: isDone ? "â" : "",
      vaccine: item.vaccine,
      dose: getPdfDoseDetails(item),
      scheduledFrom,
      scheduledTo,
      scheduledRange: `${fmt(scheduledFrom)} to ${fmt(scheduledTo)}`,
      status: isDone ? "Completed" : (status.kind === "due" ? "Due now" : (status.kind === "upcoming" ? "Due later" : "Missed")),
      missedRange: missedFrom ? `${fmt(missedFrom)} to ${fmt(missedTo)}` : "-"
    };
  });
  rows.sort((a, b) => a.scheduledFrom - b.scheduledFrom || a.scheduledTo - b.scheduledTo || a.vaccine.localeCompare(b.vaccine));
  return rows;
}

function getSupplementRowsForAge() {
  const ageDays = state.ageDays;
  const vitK = ageDays <= 1
    ? "Vitamin K1 prophylaxis at birth."
    : "Birth prophylaxis completed; additional dose only if clinically indicated.";
  const vitKRec = ageDays <= 1
    ? "Example: vitamin K1 injection 1 mg IM single dose (preterm/LBW often 0.5 mg IM by protocol)."
    : "No routine repeat in healthy infant/child unless advised.";

  const vitA = (ageDays >= 270 && ageDays <= 5 * 365)
    ? "9 months to 5 years program window."
    : "Outside routine prophylaxis window unless indicated.";
  const vitARec = (ageDays >= 270 && ageDays <= 5 * 365)
    ? "Example retinyl palmitate oral solution 100,000 IU/ml: 1 ml (100,000 IU) at 9 months, then 2 ml (200,000 IU) every 6 months up to 5 years (program prophylaxis doses)."
    : "Dietary sources + clinician/program decision.";

  const vitD = ageDays <= 365 ? "Infancy focus." : "Child/adolescent maintenance.";
  const vitDRec = ageDays <= 365
    ? "Cholecalciferol drops 400 IU/day (example 400 IU/ml: 1 ml daily OR 800 IU/ml: 0.5 ml daily)."
    : "About 600 IU/day (drops/tablet by label and clinician guidance).";

  const iron = (ageDays >= 180 && ageDays <= 59 * 30)
    ? "6-59 months prophylaxis window."
    : "Outside routine prophylaxis window (consider if deficiency risk).";
  const ironRec = (ageDays >= 180 && ageDays <= 59 * 30)
    ? "IFA pediatric syrup example: 1 ml biweekly (~20 mg elemental iron + 100 mcg folic acid)."
    : "Oral iron syrup/tablet if Hb/risk indicates; dose by clinician.";

  const calcium = ageDays <= 365
    ? "Infancy (diet-first)."
    : (ageDays <= 10 * 365 ? "Childhood." : "Adolescence.");
  const calciumRec = ageDays <= 365
    ? "Prefer breastmilk/formula and diet; if needed, calcium drops/syrup by pediatric advice."
    : (ageDays <= 10 * 365
      ? "Typical requirement 600-1000 mg/day; supplement syrup/tablet if intake low."
      : "Typical requirement 1000-1300 mg/day; diet Â± supplement as advised.");

  return [
    { supplement: "Vitamin K", age: vitK, rec: vitKRec },
    { supplement: "Vitamin A", age: vitA, rec: vitARec },
    { supplement: "Vitamin D", age: vitD, rec: vitDRec },
    { supplement: "Iron", age: iron, rec: ironRec },
    { supplement: "Calcium", age: calcium, rec: calciumRec }
  ];
}

function buildSupplementTable() {
  if (!els.supplementBody) return;
  els.supplementBody.innerHTML = "";
  getSupplementRowsForAge().forEach((row) => {
    const tr = document.createElement("tr");
    [row.supplement, row.age, row.rec].forEach((value) => {
      const td = document.createElement("td");
      td.textContent = value;
      tr.appendChild(td);
    });
    els.supplementBody.appendChild(tr);
  });
}

function fillTableBody(tbody, rows, keys) {
  if (!tbody) return;
  tbody.innerHTML = "";
  rows.forEach((row) => {
    const tr = document.createElement("tr");
    keys.forEach((key) => {
      const td = document.createElement("td");
      td.textContent = row[key];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function buildReferenceTables() {
  fillTableBody(els.dptVarBody, dptVariantRows, ["variant", "advised", "schedule", "formulation", "site"]);
  fillTableBody(els.pcvVarBody, pcvVariantRows, ["vaccine", "indication", "schedule", "formulation", "site"]);
  fillTableBody(els.specialSituBody, specialSituationRows, ["situation", "considerations", "schedule", "formulation", "site"]);
}

function buildPregnancyTables() {
  fillTableBody(els.pregVaxBody, pregnancyVaccineRows, ["vaccine", "timing", "schedule", "formulation", "site", "benefit"]);
  fillTableBody(els.pregTrimesterBody, pregnancyTrimesterRows, ["trimester", "vaxPlan", "ifaPlan", "notes"]);
  fillTableBody(els.pregIfaBody, pregnancyIfaRows, ["item", "dose", "formulation", "window"]);
}

function buildPassiveTables() {
  fillTableBody(
    els.passiveLifeBody,
    passiveLifecycleRows,
    ["stage", "situation", "product", "dose", "formulation", "routeSite", "timing", "notes"]
  );
  fillTableBody(
    els.passiveFocusBody,
    passiveFocusRows,
    ["situation", "approach", "doseSchedule", "siteRoute", "formulation", "notes"]
  );
  fillTableBody(
    els.decisionMatrixBody,
    decisionMatrixRows,
    ["exposure", "product", "window", "dose", "routeSite", "pairWith"]
  );
  fillTableBody(
    els.rabiesDetailBody,
    rabiesDetailRows,
    ["age", "category", "passive", "dose", "vaccine", "routeSite", "formulation", "instruction"]
  );
}

function getAefiLines() {
  return [
    "Stage 1 (Observation immediately after vaccine): observe child for at least 30 minutes at session site for breathing difficulty, widespread rash, collapse, persistent vomiting, or altered sensorium.",
    "Stage 2 (Expected minor reactions and home care): pain/swelling at injection site, mild fever, irritability, reduced feeding for 24-48 hours can occur. Give fluids; use age/weight-appropriate paracetamol only if needed (typically 10-15 mg/kg per dose).",
    "Stage 3 (When to seek urgent medical care): fever >=39 C, persistent inconsolable cry >3 hours, convulsion, breathing difficulty, facial swelling, generalized urticaria, persistent vomiting, hypotonia, poor responsiveness, worsening local swelling/abscess.",
    "Stage 4 (Emergency management pathway): if anaphylaxis suspected, immediate IM adrenaline 1:1000 (0.01 ml/kg, max 0.5 ml) in anterolateral thigh, repeat every 3-5 minutes as needed; airway/oxygen/urgent referral.",
    "Normal BCG healing process: small papule in 2-3 weeks, then pustule/ulcer, followed by crust and a small scar over ~6-12 weeks; keep clean and dry, avoid squeezing or applying irritant ointments.",
    "DPT/DTwP/DTaP expected reactions: fever and local pain/swelling are common in first 24-48 hours; usually settle with fluids, comfort, and fever care. Persistent high fever or unusual drowsiness needs medical review."
  ];
}

function renderAefiSection() {
  if (!els.aefiList) return;
  els.aefiList.innerHTML = "";
  getAefiLines().forEach((line) => {
    const li = document.createElement("li");
    li.textContent = line;
    els.aefiList.appendChild(li);
  });
}

function getPdfDoseDetails(item) {
  const route = getPreferredRoute(item);
  const site = getPreferredSiteByAge(item);
  const formulation = getExampleFormulation(item);
  return `Route: ${route} | Site: ${site} | Example: ${formulation}`;
}

function getPreferredRoute(item) {
  switch (item.vaccineKey) {
    case "bcg":
      return "ID";
    case "opv":
    case "rvv":
      return "ORAL";
    case "mr":
    case "mmr_opt":
    case "je":
    case "varicella":
      return "SC";
    case "ipv":
      return "ID/IM";
    default:
      return "IM";
  }
}

function getPreferredSiteByAge(item) {
  const infant = state.ageDays < 365;
  const toddler = state.ageDays >= 365 && state.ageDays < 3 * 365;

  switch (item.vaccineKey) {
    case "bcg":
      return "Left upper arm (intradermal)";
    case "opv":
    case "rvv":
      return "Oral cavity";
    case "mr":
    case "mmr_opt":
    case "je":
    case "varicella":
      return "Upper arm (subcutaneous)";
    case "ipv":
      return infant ? "Upper arm (ID fractional) or thigh (IM full dose)" : "Upper arm/deltoid as per product route";
    case "hib":
      return infant ? "Anterolateral thigh (IM)" : "Deltoid or thigh (IM)";
    case "hepb":
      return infant ? "Anterolateral thigh (IM)" : "Deltoid or thigh (IM)";
    case "dtp":
      return toddler ? "Anterolateral thigh or deltoid (IM)" : "Deltoid (IM) if age-eligible";
    case "td":
    case "hpv":
    case "menacwy":
    case "menb":
      return "Deltoid (IM)";
    case "pcv":
    case "pcv_add":
    case "hepa":
    case "typhoid":
    case "influenza":
      return infant || toddler ? "Anterolateral thigh (IM)" : "Deltoid (IM)";
    case "covid":
      return infant ? "Anterolateral thigh (IM)" : "Deltoid (IM)";
    default:
      return item.site || "Age-appropriate site";
  }
}

function getExampleFormulation(item) {
  const examples = {
    bcg: "BCG vaccine lyophilized vial + diluent, 0.1 ml dose",
    opv: "bOPV oral drops bottle, 2 drops",
    rvv: "Rotavirus oral vaccine tube/vial, oral dose per brand schedule",
    hepb: "Recombinant HepB pediatric vial/PFS 10 mcg/0.5 ml",
    hib: "Hib conjugate vial/PFS 0.5 ml (or combination product component)",
    ipv: "IPV vial/PFS (fractional 0.1 ml ID or full 0.5 ml IM as per program)",
    dtp: "DTwP/DTaP/Tdap/Td(dT) vials or PFS, commonly 0.5 ml dose",
    td: "Td or dT toxoid vial/PFS, 0.5 ml",
    mr: "MR/MMR lyophilized vial + diluent, 0.5 ml after reconstitution",
    mmr_opt: "MMR lyophilized vial + diluent, 0.5 ml",
    je: "JE vaccine vial + diluent, 0.5 ml (as program product)",
    pcv: "PCV10/PCV13 vial or PFS, 0.5 ml",
    pcv_add: "PCV10/PCV13 catch-up dose vial/PFS, 0.5 ml (IAP additional schedule)",
    varicella: "Varicella live vaccine vial + diluent, 0.5 ml",
    hepa: "HepA inactivated vial/PFS, 0.5 ml pediatric (brand-dependent)",
    typhoid: "Typhoid conjugate vaccine (TCV) vial/PFS, 0.5 ml",
    hpv: "HPV vial/PFS (bivalent/quadrivalent/nonavalent), 0.5 ml",
    influenza: "Quadrivalent influenza vaccine vial/PFS, 0.25 ml or 0.5 ml by age/product",
    menacwy: "MenACWY conjugate vial/PFS, 0.5 ml",
    menb: "MenB vaccine vial/PFS, 0.5 ml (brand schedule dependent)",
    covid: "Age-specific COVID vaccine vial/PFS, often 0.25/0.3/0.5 ml by product"
  };
  return examples[item.vaccineKey] || `${item.dose || "Dose"} formulation as per product label`;
}

function buildPdfPreviewTable(lists) {
  const rows = getPdfRows(lists);
  els.pdfBody.innerHTML = "";
  rows.forEach((row) => {
    const tr = document.createElement("tr");
    [row.tick, row.vaccine, row.dose, row.scheduledRange, row.status, row.missedRange].forEach((value) => {
      const td = document.createElement("td");
      td.textContent = value;
      tr.appendChild(td);
    });
    els.pdfBody.appendChild(tr);
  });
}

function copyWithFallback(text, textareaEl, buttonEl, failMessage) {
  const onSuccess = () => {
    els.error.textContent = "";
    const original = buttonEl.textContent;
    buttonEl.textContent = "Copied";
    setTimeout(() => {
      buttonEl.textContent = original;
    }, 1200);
  };

  const fallbackCopy = () => {
    try {
      const temp = document.createElement("textarea");
      temp.value = text || "";
      temp.setAttribute("readonly", "readonly");
      temp.style.position = "fixed";
      temp.style.opacity = "0";
      temp.style.left = "-9999px";
      document.body.appendChild(temp);
      temp.focus();
      temp.select();
      temp.setSelectionRange(0, temp.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(temp);
      if (ok) {
        onSuccess();
      } else {
        els.error.textContent = failMessage;
      }
    } catch (_) {
      els.error.textContent = failMessage;
    }
  };

  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(onSuccess).catch(fallbackCopy);
  } else {
    fallbackCopy();
  }
}

function doPrint() {
  try {
    window.print();
  } catch (_) {
    els.error.textContent = "Print action failed in this browser context.";
  }
}

function printPdfReport() {
  const lists = getLists();
  const rows = getPdfRows(lists);
  const name = (els.name.value || "Child").trim();
  const sex = (els.sex.value || "not specified").trim();
  const header = `Immunisation PDF Report | Name: ${name} | Sex: ${sex} | Assessment: ${fmt(state.assessmentDate)} | Age: ${toAgeString(state.ageDays)}`;
  const tableRowsHtml = rows.map((r) => (
    `<tr><td>${escapeHtml(r.tick)}</td><td>${escapeHtml(r.vaccine)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.scheduledRange)}</td><td>${escapeHtml(r.status)}</td><td>${escapeHtml(r.missedRange)}</td></tr>`
  )).join("");
  const supplementRowsHtml = getSupplementRowsForAge().map((s) => (
    `<tr><td>${escapeHtml(s.supplement)}</td><td>${escapeHtml(s.age)}</td><td>${escapeHtml(s.rec)}</td></tr>`
  )).join("");
  const dptRowsHtml = dptVariantRows.map((r) => (
    `<tr><td>${escapeHtml(r.variant)}</td><td>${escapeHtml(r.advised)}</td><td>${escapeHtml(r.schedule)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.site)}</td></tr>`
  )).join("");
  const pcvRowsHtml = pcvVariantRows.map((r) => (
    `<tr><td>${escapeHtml(r.vaccine)}</td><td>${escapeHtml(r.indication)}</td><td>${escapeHtml(r.schedule)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.site)}</td></tr>`
  )).join("");
  const specialRowsHtml = specialSituationRows.map((r) => (
    `<tr><td>${escapeHtml(r.situation)}</td><td>${escapeHtml(r.considerations)}</td><td>${escapeHtml(r.schedule)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.site)}</td></tr>`
  )).join("");
  const pregVaxRowsHtml = pregnancyVaccineRows.map((r) => (
    `<tr><td>${escapeHtml(r.vaccine)}</td><td>${escapeHtml(r.timing)}</td><td>${escapeHtml(r.schedule)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.site)}</td><td>${escapeHtml(r.benefit)}</td></tr>`
  )).join("");
  const pregTrimRowsHtml = pregnancyTrimesterRows.map((r) => (
    `<tr><td>${escapeHtml(r.trimester)}</td><td>${escapeHtml(r.vaxPlan)}</td><td>${escapeHtml(r.ifaPlan)}</td><td>${escapeHtml(r.notes)}</td></tr>`
  )).join("");
  const pregIfaRowsHtml = pregnancyIfaRows.map((r) => (
    `<tr><td>${escapeHtml(r.item)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.window)}</td></tr>`
  )).join("");
  const passiveLifeRowsHtml = passiveLifecycleRows.map((r) => (
    `<tr><td>${escapeHtml(r.stage)}</td><td>${escapeHtml(r.situation)}</td><td>${escapeHtml(r.product)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.routeSite)}</td><td>${escapeHtml(r.timing)}</td><td>${escapeHtml(r.notes)}</td></tr>`
  )).join("");
  const passiveFocusRowsHtml = passiveFocusRows.map((r) => (
    `<tr><td>${escapeHtml(r.situation)}</td><td>${escapeHtml(r.approach)}</td><td>${escapeHtml(r.doseSchedule)}</td><td>${escapeHtml(r.siteRoute)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.notes)}</td></tr>`
  )).join("");
  const decisionRowsHtml = decisionMatrixRows.map((r) => (
    `<tr><td>${escapeHtml(r.exposure)}</td><td>${escapeHtml(r.product)}</td><td>${escapeHtml(r.window)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.routeSite)}</td><td>${escapeHtml(r.pairWith)}</td></tr>`
  )).join("");
  const rabiesRowsHtml = rabiesDetailRows.map((r) => (
    `<tr><td>${escapeHtml(r.age)}</td><td>${escapeHtml(r.category)}</td><td>${escapeHtml(r.passive)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.vaccine)}</td><td>${escapeHtml(r.routeSite)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.instruction)}</td></tr>`
  )).join("");

  const html = `<!doctype html>
<html><head><meta charset="utf-8"><title>Immunisation PDF Report</title>
<style>
body{font-family:Arial,sans-serif;margin:18px;color:#12263a}
h1{font-size:18px;margin:0 0 12px}
h2{font-size:14px;margin:14px 0 8px}
ul{margin:0 0 0 18px;padding:0}
li{margin:4px 0;font-size:12px;line-height:1.35}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #cdd8e5;padding:6px;text-align:left;vertical-align:top}
th{background:#edf4ff}
.page-break{break-before:page;page-break-before:always}
</style></head><body>
<h1>${escapeHtml(header)}</h1>
<table>
<thead><tr><th>Tick</th><th>Vaccine</th><th>Dose (Route + Preferred Site + Example Formulation)</th><th>Scheduled Range</th><th>Current Status</th><th>If Missed, Take Between</th></tr></thead>
<tbody>${tableRowsHtml}</tbody>
</table>
<h2>Supplements by age (tabular)</h2>
<table>
<thead><tr><th>Supplement</th><th>Age Applicability</th><th>Recommendation (example formulation + dose)</th></tr></thead>
<tbody>${supplementRowsHtml}</tbody>
</table>
<h2>AEFI and expected post-vaccination reactions</h2>
<ul>${getAefiLines().map((line) => `<li>${escapeHtml(line)}</li>`).join("")}</ul>
<div class="page-break"></div>
<h2>DPT variant guide</h2>
<table>
<thead><tr><th>Vaccine Variant</th><th>Advised For / Age Range</th><th>Dose + Schedule</th><th>Formulation Example</th><th>Route + Preferred Site</th></tr></thead>
<tbody>${dptRowsHtml}</tbody>
</table>
<h2>Pneumococcal variants (valent-based situations)</h2>
<table>
<thead><tr><th>Vaccine</th><th>Typical Situation / Indication</th><th>Dose + Schedule</th><th>Formulation Example</th><th>Route + Site</th></tr></thead>
<tbody>${pcvRowsHtml}</tbody>
</table>
<h2>Special situations (including immunocompromised)</h2>
<table>
<thead><tr><th>Situation</th><th>Vaccine Considerations</th><th>Dose / Schedule Direction</th><th>Formulation Example</th><th>Route + Site</th></tr></thead>
<tbody>${specialRowsHtml}</tbody>
</table>
<div class="page-break"></div>
<h2>Pregnancy vaccination and iron-folic supplementation</h2>
<table>
<thead><tr><th>Vaccine</th><th>Trimester / Timing</th><th>Dose + Schedule</th><th>Formulation Example</th><th>Route + Site</th><th>Fetal / Neonatal Benefit</th></tr></thead>
<tbody>${pregVaxRowsHtml}</tbody>
</table>
<h2>Trimester-wise pregnancy plan</h2>
<table>
<thead><tr><th>Trimester</th><th>Vaccination Plan</th><th>Iron + Folic Acid Plan</th><th>Key Notes</th></tr></thead>
<tbody>${pregTrimRowsHtml}</tbody>
</table>
<h2>Iron and folic acid details (dose + formulation)</h2>
<table>
<thead><tr><th>Supplement Item</th><th>Dose Recommendation</th><th>Formulation Example</th><th>Use Window</th></tr></thead>
<tbody>${pregIfaRowsHtml}</tbody>
</table>
<div class="page-break"></div>
<h2>Passive immunization across life stages</h2>
<table>
<thead><tr><th>Life Stage</th><th>Situation</th><th>Passive Product</th><th>Dose</th><th>Formulation Example</th><th>Route + Site</th><th>Schedule / Timing</th><th>Key Notes</th></tr></thead>
<tbody>${passiveLifeRowsHtml}</tbody>
</table>
<h2>Specific situations: HIV, Hepatitis B, Rabies and immunocompromised</h2>
<table>
<thead><tr><th>Specific Situation</th><th>Recommended Product / Approach</th><th>Dose + Schedule</th><th>Site / Route</th><th>Formulation Example</th><th>Practical Notes</th></tr></thead>
<tbody>${passiveFocusRowsHtml}</tbody>
</table>
<h2>Decision matrix (rapid use)</h2>
<table>
<thead><tr><th>Exposure / Scenario</th><th>Passive Product</th><th>Time Window</th><th>Dose</th><th>Route + Site</th><th>Pair With</th></tr></thead>
<tbody>${decisionRowsHtml}</tbody>
</table>
<h2>Rabies detailed schedule (category and age-wise)</h2>
<table>
<thead><tr><th>Age Group</th><th>Exposure Category</th><th>Passive Product</th><th>Dose</th><th>Vaccine Schedule (if indicated)</th><th>Route + Site</th><th>Formulation Example</th><th>Key Instruction</th></tr></thead>
<tbody>${rabiesRowsHtml}</tbody>
</table>
</body></html>`;

  const w = window.open("", "_blank");
  if (!w) {
    els.error.textContent = "Popup blocked. Allow popups, then click Print PDF Table again.";
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

function printPdfPage2() {
  const name = (els.name.value || "Child").trim();
  const sex = (els.sex.value || "not specified").trim();
  const header = `Page 2 PDF | Pregnancy Vaccination and IFA | Name: ${name} | Sex: ${sex} | Assessment: ${fmt(state.assessmentDate)}`;
  const pregVaxRowsHtml = pregnancyVaccineRows.map((r) => (
    `<tr><td>${escapeHtml(r.vaccine)}</td><td>${escapeHtml(r.timing)}</td><td>${escapeHtml(r.schedule)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.site)}</td><td>${escapeHtml(r.benefit)}</td></tr>`
  )).join("");
  const pregTrimRowsHtml = pregnancyTrimesterRows.map((r) => (
    `<tr><td>${escapeHtml(r.trimester)}</td><td>${escapeHtml(r.vaxPlan)}</td><td>${escapeHtml(r.ifaPlan)}</td><td>${escapeHtml(r.notes)}</td></tr>`
  )).join("");
  const pregIfaRowsHtml = pregnancyIfaRows.map((r) => (
    `<tr><td>${escapeHtml(r.item)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.window)}</td></tr>`
  )).join("");

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Page 2 PDF</title>
<style>
body{font-family:Arial,sans-serif;margin:18px;color:#12263a}
h1{font-size:18px;margin:0 0 12px}
h2{font-size:14px;margin:14px 0 8px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #cdd8e5;padding:6px;text-align:left;vertical-align:top}
th{background:#edf4ff}
</style></head><body>
<h1>${escapeHtml(header)}</h1>
<h2>Pregnancy vaccination table</h2>
<table><thead><tr><th>Vaccine</th><th>Trimester / Timing</th><th>Dose + Schedule</th><th>Formulation Example</th><th>Route + Site</th><th>Fetal / Neonatal Benefit</th></tr></thead><tbody>${pregVaxRowsHtml}</tbody></table>
<h2>Trimester-wise pregnancy plan</h2>
<table><thead><tr><th>Trimester</th><th>Vaccination Plan</th><th>Iron + Folic Acid Plan</th><th>Key Notes</th></tr></thead><tbody>${pregTrimRowsHtml}</tbody></table>
<h2>Iron and folic acid details</h2>
<table><thead><tr><th>Supplement Item</th><th>Dose Recommendation</th><th>Formulation Example</th><th>Use Window</th></tr></thead><tbody>${pregIfaRowsHtml}</tbody></table>
</body></html>`;
  openPrintWindow(html, "Page 2 PDF");
}

function printPdfPage3() {
  const name = (els.name.value || "Child").trim();
  const sex = (els.sex.value || "not specified").trim();
  const header = `Page 3 PDF | Passive Immunization | Name: ${name} | Sex: ${sex} | Assessment: ${fmt(state.assessmentDate)}`;
  const passiveLifeRowsHtml = passiveLifecycleRows.map((r) => (
    `<tr><td>${escapeHtml(r.stage)}</td><td>${escapeHtml(r.situation)}</td><td>${escapeHtml(r.product)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.routeSite)}</td><td>${escapeHtml(r.timing)}</td><td>${escapeHtml(r.notes)}</td></tr>`
  )).join("");
  const passiveFocusRowsHtml = passiveFocusRows.map((r) => (
    `<tr><td>${escapeHtml(r.situation)}</td><td>${escapeHtml(r.approach)}</td><td>${escapeHtml(r.doseSchedule)}</td><td>${escapeHtml(r.siteRoute)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.notes)}</td></tr>`
  )).join("");
  const decisionRowsHtml = decisionMatrixRows.map((r) => (
    `<tr><td>${escapeHtml(r.exposure)}</td><td>${escapeHtml(r.product)}</td><td>${escapeHtml(r.window)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.routeSite)}</td><td>${escapeHtml(r.pairWith)}</td></tr>`
  )).join("");
  const rabiesRowsHtml = rabiesDetailRows.map((r) => (
    `<tr><td>${escapeHtml(r.age)}</td><td>${escapeHtml(r.category)}</td><td>${escapeHtml(r.passive)}</td><td>${escapeHtml(r.dose)}</td><td>${escapeHtml(r.vaccine)}</td><td>${escapeHtml(r.routeSite)}</td><td>${escapeHtml(r.formulation)}</td><td>${escapeHtml(r.instruction)}</td></tr>`
  )).join("");

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Page 3 PDF</title>
<style>
body{font-family:Arial,sans-serif;margin:18px;color:#12263a}
h1{font-size:18px;margin:0 0 12px}
h2{font-size:14px;margin:14px 0 8px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #cdd8e5;padding:6px;text-align:left;vertical-align:top}
th{background:#edf4ff}
</style></head><body>
<h1>${escapeHtml(header)}</h1>
<h2>Passive immunization across life stages</h2>
<table><thead><tr><th>Life Stage</th><th>Situation</th><th>Passive Product</th><th>Dose</th><th>Formulation Example</th><th>Route + Site</th><th>Schedule / Timing</th><th>Key Notes</th></tr></thead><tbody>${passiveLifeRowsHtml}</tbody></table>
<h2>Specific situations: HIV, Hepatitis B, Rabies and immunocompromised</h2>
<table><thead><tr><th>Specific Situation</th><th>Recommended Product / Approach</th><th>Dose + Schedule</th><th>Site / Route</th><th>Formulation Example</th><th>Practical Notes</th></tr></thead><tbody>${passiveFocusRowsHtml}</tbody></table>
<h2>Decision matrix (rapid use)</h2>
<table><thead><tr><th>Exposure / Scenario</th><th>Passive Product</th><th>Time Window</th><th>Dose</th><th>Route + Site</th><th>Pair With</th></tr></thead><tbody>${decisionRowsHtml}</tbody></table>
<h2>Rabies detailed schedule (category and age-wise)</h2>
<table><thead><tr><th>Age Group</th><th>Exposure Category</th><th>Passive Product</th><th>Dose</th><th>Vaccine Schedule (if indicated)</th><th>Route + Site</th><th>Formulation Example</th><th>Key Instruction</th></tr></thead><tbody>${rabiesRowsHtml}</tbody></table>
</body></html>`;
  openPrintWindow(html, "Page 3 PDF");
}

function openPrintWindow(html, blockedMessageLabel) {
  const w = window.open("", "_blank");
  if (!w) {
    els.error.textContent = `Popup blocked. Allow popups, then click ${blockedMessageLabel} again.`;
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

function escapeHtml(v) {
  return String(v)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function parseDate(v) {
  if (!v) return null;
  const d = new Date(`${v}T00:00:00`);
  return Number.isNaN(d.getTime()) ? null : d;
}

function addDays(date, d) {
  return new Date(date.getTime() + d * DAY);
}

function fmt(date) {
  return date.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
}

function toDateInput(date) {
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, "0");
  const dd = String(date.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function toAgeString(totalDays) {
  const years = Math.floor(totalDays / 365);
  const months = Math.floor((totalDays % 365) / 30);
  const days = Math.floor((totalDays % 365) % 30);
  return `${years}y ${months}m ${days}d`;
}
  </script>
</body>
</html>
